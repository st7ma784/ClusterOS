services:
  # Bootstrap node (node1)
  node1:
    build:
      context: ../..
      dockerfile: node/Dockerfile
    hostname: node1
    container_name: cluster-os-node1
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
      - SYS_ADMIN
    security_opt:
      - seccomp:unconfined
    tmpfs:
      - /run
      - /run/lock
      - /tmp
      - /var/run/dbus
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - node1-data:/var/lib/cluster-os
      - node1-log:/var/log/cluster-os
      - slurm-config:/etc/slurm:rw
      - slurm-state:/var/lib/slurm:rw
    environment:
      - NODE_NAME=node1
      - NODE_BOOTSTRAP=true
      - NODE_K3S_ENABLED=true
      - SERF_BIND_PORT=7946
      - RAFT_BIND_PORT=7373
      - WIREGUARD_PORT=51820
      - CLUSTER_AUTH_KEY=7RB0TPs+d/VuD3rL/7ZD2JEcpA14aNCBvLOPHwEBy9s=
    networks:
      cluster_net:
        ipv4_address: 10.90.0.10
    ports:
      - "7946:7946/tcp"
      - "7946:7946/udp"
    healthcheck:
      test: ["CMD", "/usr/local/bin/node-agent", "info"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  # Worker node 2
  node2:
    build:
      context: ../..
      dockerfile: node/Dockerfile
    hostname: node2
    container_name: cluster-os-node2
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
      - SYS_ADMIN
    security_opt:
      - seccomp:unconfined
    tmpfs:
      - /run
      - /run/lock
      - /tmp
      - /var/run/dbus
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - node2-data:/var/lib/cluster-os
      - node2-log:/var/log/cluster-os
      - slurm-config:/etc/slurm:rw
      - slurm-state:/var/lib/slurm:rw
    environment:
      - NODE_NAME=node2
      - NODE_BOOTSTRAP=false
      - NODE_JOIN=node1:7946
      - SERF_BIND_PORT=7946
      - RAFT_BIND_PORT=7373
      - WIREGUARD_PORT=51820
      - CLUSTER_AUTH_KEY=7RB0TPs+d/VuD3rL/7ZD2JEcpA14aNCBvLOPHwEBy9s=
    networks:
      cluster_net:
        ipv4_address: 10.90.0.11
    depends_on:
      node1:
        condition: service_healthy

  # Worker node 3
  node3:
    build:
      context: ../..
      dockerfile: node/Dockerfile
    hostname: node3
    container_name: cluster-os-node3
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
      - SYS_ADMIN
    security_opt:
      - seccomp:unconfined
    tmpfs:
      - /run
      - /run/lock
      - /tmp
      - /var/run/dbus
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - node3-data:/var/lib/cluster-os
      - node3-log:/var/log/cluster-os
      - slurm-config:/etc/slurm:rw
      - slurm-state:/var/lib/slurm:rw
    environment:
      - NODE_NAME=node3
      - NODE_BOOTSTRAP=false
      - NODE_JOIN=node1:7946
      - SERF_BIND_PORT=7946
      - RAFT_BIND_PORT=7373
      - WIREGUARD_PORT=51820
      - CLUSTER_AUTH_KEY=7RB0TPs+d/VuD3rL/7ZD2JEcpA14aNCBvLOPHwEBy9s=
    networks:
      cluster_net:
        ipv4_address: 10.90.0.12
    depends_on:
      node1:
        condition: service_healthy

  # Worker node 4
  node4:
    build:
      context: ../..
      dockerfile: node/Dockerfile
    hostname: node4
    container_name: cluster-os-node4
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
      - SYS_ADMIN
    security_opt:
      - seccomp:unconfined
    tmpfs:
      - /run
      - /run/lock
      - /tmp
      - /var/run/dbus
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - node4-data:/var/lib/cluster-os
      - node4-log:/var/log/cluster-os
      - slurm-config:/etc/slurm:rw
      - slurm-state:/var/lib/slurm:rw
    environment:
      - NODE_NAME=node4
      - NODE_BOOTSTRAP=false
      - NODE_JOIN=node1:7946
      - SERF_BIND_PORT=7946
      - RAFT_BIND_PORT=7373
      - WIREGUARD_PORT=51820
      - CLUSTER_AUTH_KEY=7RB0TPs+d/VuD3rL/7ZD2JEcpA14aNCBvLOPHwEBy9s=
    networks:
      cluster_net:
        ipv4_address: 10.90.0.13
    depends_on:
      node1:
        condition: service_healthy

  # Worker node 5
  node5:
    build:
      context: ../..
      dockerfile: node/Dockerfile
    hostname: node5
    container_name: cluster-os-node5
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
      - SYS_ADMIN
    security_opt:
      - seccomp:unconfined
    tmpfs:
      - /run
      - /run/lock
      - /tmp
      - /var/run/dbus
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - node5-data:/var/lib/cluster-os
      - node5-log:/var/log/cluster-os
      - slurm-config:/etc/slurm:rw
      - slurm-state:/var/lib/slurm:rw
    environment:
      - NODE_NAME=node5
      - NODE_BOOTSTRAP=false
      - NODE_JOIN=node1:7946
      - SERF_BIND_PORT=7946
      - RAFT_BIND_PORT=7373
      - WIREGUARD_PORT=51820
      - CLUSTER_AUTH_KEY=7RB0TPs+d/VuD3rL/7ZD2JEcpA14aNCBvLOPHwEBy9s=
    networks:
      cluster_net:
        ipv4_address: 10.90.0.14
    depends_on:
      node1:
        condition: service_healthy

networks:
  cluster_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.90.0.0/16

volumes:
  node1-data:
    driver: local
  node1-log:
    driver: local
  node2-data:
    driver: local
  node2-log:
    driver: local
  node3-data:
    driver: local
  node3-log:
    driver: local
  node4-data:
    driver: local
  node4-log:
    driver: local
  node5-data:
    driver: local
  node5-log:
    driver: local
  slurm-config:
    driver: local
  slurm-state:
    driver: local
