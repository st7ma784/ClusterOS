#cloud-config
autoinstall:
  version: 1

  locale: en_US.UTF-8
  keyboard:
    layout: us

  # Skip network configuration during install (will be set up later)
  network:
    version: 2
    ethernets:
      ens3:
        dhcp4: true

  # Identity
  identity:
    hostname: cluster-node
    username: clusteros
    # Password: clusteros (generated with: openssl passwd -6 -salt 'rounds=4096$clusteros' 'clusteros')
    password: "$6$rounds=4096$clusteros$1i31BmUt2FgJvT4.xUyOUM53UNX7BEXXD5M3hw9hy9KtV1jh.SeUNR0BvUj6mrkeUW9PrueAvBeVN2Ssmu3w71"

  # SSH
  ssh:
    install-server: true
    allow-pw: true

  # Storage
  storage:
    layout:
      name: direct
      match:
        size: largest

  # Packages to install
  packages:
    - openssh-server
    - cloud-init
    - net-tools
    - curl
    - wget

  # Late commands to run after installation
  late-commands:
    - echo 'clusteros ALL=(ALL) NOPASSWD:ALL' > /target/etc/sudoers.d/clusteros
    - curtin in-target --target=/target -- chmod 440 /etc/sudoers.d/clusteros
    - curtin in-target --target=/target -- systemctl enable ssh

  # Automatically reboot after install
  shutdown: reboot
